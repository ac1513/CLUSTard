configfile: "config.yaml"

import pandas as pd
df_samples = pd.read_csv(config["samples"], sep ='\t', index_col = 0)
samples = df_samples["sample"].to_list()

JOBID = config["jobid"]
RAW_SR = config["RAW_SR"]
REFIN = config["REFIN"]
CONTIG_T = config["CONTIG_T"]
P_THRESH = config["P_THRESH"]
krakendb = config["krakendb"]
kraken_level = config["kraken_level"]


(job, part) = glob_wildcards('inter/{JOBID}_diffs{PART}.csv')

rule all:
    input:
      expand("bins/{JOBID}_output_{PART}.csv", JOBID = JOBID, PART = part),
      expand("bins/{JOBID}_parallel_sets_{PART}.csv", JOBID = JOBID, PART = part),
      expand("bins/{JOBID}_parallel_merged.out", JOBID = JOBID),
      expand("results/{JOBID}_summary_stats.txt", JOBID=JOBID)

rule bin_feeder:
    input:
        diffs = 'inter/' + JOBID + '_diffs{PART}.csv'
    output:
        all = "bins/" + JOBID + "_output_{PART}.csv",
    params:
        thresh = P_THRESH, #add this in as a variable at the top later..
        all_diffs = expand("inter/{JOBID}_diffs.csv", JOBID = JOBID)
    benchmark:
        "benchmarks/bin_feeder.tsv"
    conda:
        "envs/py3.yaml"
    shell:
        """
        python scripts/bin_feeder.py {input.diffs} {params.all_diffs} {params.thresh} {output.all}
        """

rule para_sets:
    input:
        bins = "bins/" + JOBID + "_output_{PART}.csv"
    output:
        "bins/" + JOBID + "_parallel_sets_{PART}.csv"
    params:
        thresh = P_THRESH
    benchmark:
        "benchmarks/para_sets.tsv"
    conda:
        "envs/py3.yaml"
    shell:
        """
        python scripts/para_sets.py {input.bins} {output} {params.thresh}
        """

rule para_merge:
    input:
        expand("bins/{JOBID}_parallel_sets_{PART}.csv", JOBID=JOBID, PART = part)
    output:
        "bins/{JOBID}_parallel_merged.out"
    resources:
        mem_mb = 64000
    conda:
        "envs/py3.yaml"
    benchmark:
        "benchmarks/para_merge.tsv"
    shell:
        """
        python scripts/parallel_merge_step2.py -i {input} -o {output}
        """

rule non_red_step:
    input:
      expand("bins/{JOBID}_parallel_merged.out", JOBID = JOBID)
    output:
      expand("bins/{JOBID}_non_red_list.out", JOBID = JOBID)
    conda:
      "envs/py3.yaml"
    benchmark:
      "benchmarks/non_red.tsv"
    shell:
      """
      python scripts/step3.py {input} {output}
      """

rule file_parser:
    input:
        expand("bins/{JOBID}_non_red_list.out", JOBID = JOBID)
    output:
        "results/{JOBID}_summary_stats.txt"
    params:
        contigs = REFIN,
        csv = expand("inter/{JOBID}_read_counts_derived.csv", JOBID = JOBID),
        wd = "results/",
        header = samples
    shell:
        """
        mkdir -p {params.wd}
        python scripts/file_parser.py {params.contigs} {params.csv} {input} {params.wd} {output} -l {params.header}
        echo "Done" > {output}
        """
